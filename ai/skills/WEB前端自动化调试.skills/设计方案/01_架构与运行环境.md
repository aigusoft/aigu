# 架构与运行环境设计

## 功能目标
- 在 Linux 与 WSL 中统一封装 Chrome DevTools Protocol（CDP）的启动、端口管理与脚本执行流程。
- 对外始终暴露 `devtools_host/devtools_port`（默认 `127.0.0.1:9222` 或 WSL 网关:9222），内部自动处理浏览器生命周期、网络策略及日志采集。

## 核心组件
| 组件 | 说明 |
| --- | --- |
| `tools/cdp_eval.sh` | 单入口脚本，包含参数解析、环境探测、Chrome 启动、WebSocket 脚本执行与日志收集。|
| `tools/cdp_dom.sh` | 基于 `cdp_eval.sh` 的 DOM 操作包装脚本，提供 create/set/query 等命令。|
| `test/run_all.sh` | 端到端测试驱动器，复用真实脚本验证所有功能场景。|
| `test/cases/*.sh` | 精准覆盖 `--help`、参数校验、默认/自定义表达式、`--bootstrap-only` 以及手动 CDP 会话等场景。|

## 运行环境
- **依赖工具**：Bash、Python 3、curl、jq、websocat。若缺失，测试用例会提示安装。
- **浏览器**：
  - Linux：PATH 内存在 `google-chrome`/`chromium`。
  - WSL：Windows 侧已安装 Chrome，可在默认路径 `/mnt/c/Program Files/Google/Chrome/Application/chrome.exe` 找到。
- **存储**：允许写入 `/tmp`（Linux profile）以及 Windows `C:\Users\\<user>\\test_chrome_user`（WSL profile）。

## 端口与网络策略
- 对外固定使用端口 **9222**，方便脚本与测试统一连接。
- WSL 模式下：
  - Chrome 监听 `127.0.0.1:9221`。
  - 自动创建 `WSL-Chrome-Debug` 防火墙规则与 `netsh interface portproxy`，将 `<默认路由>:9222` 转发到 `127.0.0.1:9221`。
  - 启动前清理历史端口映射与 `Singleton*` 文件，并在 `Preferences` 中将 `exit_type` 重置为 `Normal`，避免“Chrome 未正常关闭”。
- Linux 模式下：Chrome 以 `--headless=new` 搭配 `--remote-debugging-port=9222` 运行，检测端口冲突后再启动。

## 用户数据与 Safe Flags
- 启动参数中禁用扩展、插件、组件更新、崩溃提示、信息条等，确保 CLI 调试过程不会弹出干扰窗口。
- 启用 `--allow-insecure-localhost`、`--allow-running-insecure-content`、`--test-type` 以放宽证书校验，并关闭 Translate/Popup 等特性。

## 日志
- Chrome 标准输出重定向到 `chrome.log`，WebSocket 交互写入 `websocat.log`。
- `--log-dir` 支持用户自定义存储路径，默认使用临时目录。会在终端回显日志位置，便于调试。
