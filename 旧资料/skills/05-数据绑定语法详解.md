# 05｜数据绑定语法详解

WCEX 提供与 Vue 相似、但直接嵌入 HTML 属性的绑定语法。理解 `$` 与 `:` 前缀的差异、双向绑定的写法以及在样式中的使用方式，是生成组件的关键。

## 5.1 基础语法
| 语法     | 适用位置       | 执行方式                            | 示例                                     |
| -------- | -------------- | ----------------------------------- | ---------------------------------------- |
| `$attr`  | 属性 / 文本    | 以 **表达式** 计算值（不包模板字面量） | `<div $title="'Hi ' + user.name"></div>` |
| `$>`     | 文本节点       | 表达式求值，结果写入元素内容          | `<h1 $>counter * 2</h1>`                |
| `:attr`  | 属性 / 文本    | 以模板字符串执行，支持 `${}` 插值     | `<div :title="用户：${user.name}"></div>` |
| `:>`     | 文本节点       | 模板字符串求值                        | `<p :>欢迎 ${user.name} 登录</p>`        |

说明：
- `$` 前缀下表达式直接求值，允许返回任意类型（对象会被原样赋值）。
- `:` 前缀会将右侧视为 JavaScript 模板字符串，最终始终返回字符串。
- 同一属性可同时声明静态值与动态值，最终以动态结果覆盖。

## 5.2 样式与 class 绑定
在 `<style>` 内使用动态值时，需要用引号包裹并以 `$` 或 `:` 开头：
```html
<style>
  :host {
    width: ":${size}px";        /* 模板写法 */
    height: "$size + 'px'";     /* 表达式写法 */
    padding: 0 "$spacing}px";
  }
  svg {
    fill: "$$color.sec";        /* 语义色（保持原格式） */
  }
</style>
```
- `"$..."` 表示表达式求值；`":..."` 表示模板字符串。
- `$$color.xxx` 在样式中表示取语义色值（保留透明度/格式，详见第 8 章）。
- 运行时会为每条样式绑定记录 `tid|selector|prop` 键，依赖变更时仅重写对应 CSS 属性，而不会重新注入整张 `<style>`，有利于保持 Shadow DOM 内样式稳定。

## 5.3 双向绑定 (`$$`)
`$$` 实现字段与元素属性/内容的同步，默认绑定 `value` 与 `change` 事件：
```html
<input $$="form.name" />                <!-- 等价于 $$value.change -->
<input $$value.input="form.name" />     <!-- 指定属性与事件 -->
```
要点：
- 双向绑定只接受可赋值的变量（不能是表达式）。
- 对于自定义组件，只要声明了 `value` 属性即可与 `$$` 配合。
- 可在同一元素上同时使用 `$` / `:` 绑定其他属性。
- 任选属性/事件可经过 `$:attr.event1.event2="model"` 或 `$::attr.event="list"` 拓展，内部会按顺序注册监听器并在事件触发时写回作用域。

## 5.4 单选 / 多选绑定
### 单选 (`$:`)
```html
<div $selected="0">
  <label $for="items">
    <input  $:="selected" type="radio" $value="value" />
    <span :>选项 ${index}</span>
  </label>
</div>
```
- `$:attr.event="变量"`：单向地将控件选中状态写入变量，默认 `attr=value`、`event=change`。
- 在上例中，`items` 循环内的每一项 `value` 会被写回到 `selected`。

### 多选 (`$::`)
```html
<div $checked="[]">
  <label $for="items">
    <input $::="checked" type="checkbox" $value="value" />
    <span :>选项 ${value}</span>
  </label>
</div>
```
- `$::` 会维护一个数组，选中时向数组添加值，取消选中时移除。
- 同样支持自定义 `attr`/`event`（如 `$::text.input="tags"`）。

## 5.5 条件与显隐
详见第 7 章，这里仅列出语法：
- `$if="表达式"`：为真时渲染节点，为假时从 DOM 移除。
- `$show="表达式"`：控制元素显隐（通常通过切换样式或 `hidden` 属性实现）。
- `$switch`/`$case`（若后续扩展有此语法，可按需补充；当前版本主要使用 `$if`）。

## 5.6 循环 (`$for`)
语法形式：`$for(item,index)="source"` 或 `$for(source)`：
```html
<div $items="[1,2,3]">
  <span $for(num,i)="items" :>${i}. ${num}</span>
</div>
```
- 不带参数时，循环变量默认注入 `value`（当前项）与 `index`（索引）。
- 可通过 `$for(key,value)="object"` 遍历对象属性。
- 循环体内的局部作用域可访问 `value`、`index`、`key` 等变量，且继续继承父级作用域属性。

### 访问循环条目的属性
```html
<div $for(type)="['opensource','free','paid']" $if="fonts[type]">
  <h4 :>${type} (${Object.keys(fonts[type]).length})</h4>
  <article $for="fonts[type]" @click="$emit('pick', value.name)">
    <img $src="$path(`@/${value.name}/font.png`)" />
  </article>
</div>
```
- `value` 自动指向当前项，`index` 为当前索引。
- `$if` 与 `$for` 可组合使用，实现复杂过滤条件。

## 5.7 动态组件与别名
在循环/条件中常需要渲染不同组件，可使用 `$cmpt`、`$as` 配合：
```html
<div $tabs="tabMap">
  <section $for="tabs" $cmpt="value.component">
    <div $as="cmpt"></div>   <!-- $id.cmpt 引用动态组件实例 -->
  </section>
</div>
```
- `$cmpt="表达式"`：将表达式结果作为组件标签渲染。可返回短名或全名。
- `$as="别名"`：为当前元素的 scope 创建别名，便于在脚本/子元素中引用。
- 动态组件语法扩展详见第 7 章。

## 5.8 表达式执行环境
- 所有绑定表达式/模板在当前局部作用域内执行，可访问根组件方法、`$props`、`$router` 等。
- 支持原生 JavaScript 语法、三元表达式、链式调用。
- 为避免副作用，表达式应保持纯粹；需要执行逻辑时，请通过事件或 `Scope` 方法完成。
- 每一条绑定都会生成形如 `eid|attr` 的 `binderKey`，并通过 `Observer.trackCall` 注册依赖；对于数组值，会额外访问 `.length` 以确保 `push/splice` 等操作能够触发重新计算。

## 5.9 合法写法示例
```html
<template>
  <meta name="scope" count.int="1" checked="[]" profile.obj="{ name:'WCEX'}" />
  <style>
    :host {
      --size: ":${count * 10}px";
    }
    .avatar {
      border-color: "$$color.pri";
    }
  </style>

  <h2 :>${profile.name} × ${count}</h2>
  <button @click="count++">Add</button>

  <label $for="['A','B','C']">
    <input $::="checked" $value="value" type="checkbox" />
    <span :>选项 ${value}</span>
  </label>

  <wcex-ui.icon $show="count > 3" $color="$color.sec" icon="star"></wcex-ui.icon>
</template>
 ```

通过熟练掌握上述绑定语法，自动化生成代码时即可准确描述数据与界面之间的关系，并与 WCEX 的响应式系统保持一致；若需在更新时引入时间差，可结合第 4 章提到的 `.lazy` 修饰或第 11 章中的 `$delay/$next/$step` 辅助函数调度渲染。

## 智能体提示
- 在回答如何绑定属性与文本的问题时，优先判断用户期待的是表达式（`$`）还是模板字符串（`:`），并提醒转换差异。
- 对表单双向绑定场景，默认建议 `$$`，若是单选/多选则引用 `$:`、`$::` 的写法，并说明可以自定义 `attr/event`。
- 样式绑定时务必提醒需包裹在引号内，并强调 `$$color` 语义色不会被字符串化破坏。
- 当涉及循环或动态组件，提示 `$for` 自动注入 `value/index`，并可结合 `$cmpt`、`$as` 管理复杂结构。
