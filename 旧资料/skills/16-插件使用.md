# 16｜插件使用

插件系统允许在模板、组件与运行期插入自定义逻辑，并向 Scope 注入全局工具。掌握其生命周期和内置示例，可以为智能体编排语法糖、调试能力或统一的团队规范。

## 16.1 核心概念
- **插件接口**：`IPlugins` 描述所有可选钩子与元数据。常见钩子包括模板阶段的 `tplPre` / `tplParse` / `tplPost`，组件阶段的 `wcPre` / `wcPost`，运行期更新的 `wcApply`、销毁阶段的 `wcDestroy`，以及作用域注入对象 `scope`。
- **执行管理**：插件在注册后由管理器按照 `priority` 排序，逐阶段串行调用，并在组件初始化时自动把 `scope` 中的成员挂到 `rootScope`。
- **默认注册**：框架启动时会预置 `$color` 与 `$monitSize`，同时开放 `WCEX.usePlugins` 供业务或 UI 库追加插件。注册应尽早完成，以确保模板解析前即可生效。

## 16.2 生命周期扩展点

| 钩子        | 触发时机与参数                                                                 | 常见用途                                   |
| ----------- | ------------------------------------------------------------------------------ | ------------------------------------------ |
| `tplPre`    | 模板加载后、解析前（`DocumentFragment`）                                        | 批量注入公共标记、裁剪/重排模板结构        |
| `tplParse`  | 逐个 `TplElem` 解析时                                                          | 自定义语法糖（如新增 `$ifslot`）           |
| `tplPost`   | 模板解析完成后                                                                  | 批量添加样式、补足依赖                     |
| `wcPre`     | 组件实例化前（`rootScope`、模板 `DocumentFragment`）                            | 初始化默认数据、挂载调试工具               |
| `wcPost`    | 组件实例化后（`rootScope`）                                                     | 启动第三方控件、设置聚焦或布局             |
| `wcApply`   | 数据绑定触发（`localScope`、`propName`、`flags`、`value`）                      | 监听特定字段变化、桥接外部状态管理         |
| `wcDestroy` | 组件销毁时                                                                      | 释放资源、撤销事件监听                     |
| `scope`     | 键值对形式注入每个 Scope，并将函数自动绑定到当前作用域                         | 提供 `$color`、`$monitSize` 等全局工具函数 |

所有钩子可返回 `Promise`，管理器会等待异步任务完成，保证执行顺序。

## 16.3 注册示例
在业务入口或 UI 库初始化阶段调用 `WCEX.usePlugins`：

```ts
const IFSLOT = "$ifslot";
WCEX.usePlugins({
  name: IFSLOT,
  priority: 0,
  tplParse(tpl) {
    if (tpl.attrs[IFSLOT]) {
      tpl.remove(IFSLOT);
      tpl.addAttrs({
        $slotattached: "0",
        "@slotchange": "slotattached=1",
        $show: "slotattached",
      });
    }
  },
});
```

实践建议：
1. **命名与优先级**：`name` 必须唯一，`priority` 越小越早执行，便于实现依赖链。
2. **幂等处理**：`tplParse`、`wcPre` 等钩子可能多次触发，务必检测并避免重复注入属性或监听器。
3. **作用域注入**：`scope: { tool() {} }` 会在组件实例化时绑定到 `rootScope`，必要时可使用 `function` 并依赖 `this` 访问当前组件。
4. **调试日志**：通过 `this.$log` 或 `WcLog` 输出关键信息，快速定位插件执行状态。

## 16.4 内置插件

### 16.4.1 `$color` 语义化配色
- 在加载阶段读取 `<meta name="colors">` 与 `localStorage.__COLORS`、`__COLOR_MODE`，转换为可观察的 `Hsla` 对象，并同步更新 `html` 元素的背景与文本色。
- Scope 注入内容：`$color`（当前语义色表）和 `$Colors`（包含 `set`、`setMode`、`switchMode`、`load`、`Hsla` 等工具）。
- `Hsla` 实例支持 `h/hs/hl/la` 等链式方法与快捷级别（如 `.l3`, `.a2_`），模板中可直接引用：  
  ```html
  <div style="background: \"$$color.pri.l2\"; color: \"$$color.textr\"">
    ...
  </div>
  ```
- 通过 `this.$Colors.set('pri', 'hsla(220,70%,50%,100)')` 可即时调整主色，并持久化到本地存储。

### 16.4.2 `$monitSize` 组件尺寸监听
- 向 Scope 注入 `$monitSize(el, callback)`，内部维护单例 `ResizeObserver` 并在组件销毁时自动断开。
- 回调接收 `ResizeObserverEntry`，可结合 `entry.contentRect` 计算自适应布局，例如 `this.$monitSize(this.$id.panel, entry => this.width = entry.contentRect.width);`。

## 16.5 插件开发提示
- **跨阶段共享状态**：可将数据保存在插件实例上（`this.someState`）或模块级变量，避免使用全局单例。
- **模板清理**：自定义语法糖应在 `tplParse` 中删除原始属性，确保最终模板语义清晰。
- **作用域安全**：`scope` 注入的对象默认关闭响应式；若需响应式副作用，可在 `wcPre` 手动调用 `rootScope.$watch`。
- **热更新友好**：插件模块通常长期驻留，若配合热更新，需自行处理重复注册或状态重置。

## 16.6 故障排查
- 注册插件后，可在控制台确认管理器打印的 `using plugins` 列表，或在插件钩子内输出调试日志。
- 无法访问注入的 Scope 成员时，先检查注册代码是否早于组件解析，并确保键名未与系统属性冲突。
- 若 `wcApply` 等钩子抛错会阻断后续更新，建议在插件内部捕获异常并通过 `this.$log.warn` 提示，以免影响同阶段的其他插件。
