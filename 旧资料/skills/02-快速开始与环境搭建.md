# 02｜快速开始与环境搭建

WCEX 可通过两种方式启动：直接在 HTML 中引入官方 CDN 脚本，或使用 `@wcex/cli` 构建完整开发流程。以下内容覆盖从零到可运行项目的关键步骤。

## 2.1 使用 CDN 快速试运行
```html
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <!-- 设置 npm 资源根（可换为任何兼容的 CDN） -->
    <meta name="npm" content="https://cdn.jsdelivr.net/npm/" />
    <!-- 可选：初始化配色模式 -->
    <meta name="colors" mode="0" pri="hsl(100,50%,50%)" />
    <!-- 核心运行时 -->
    <script src="https://cdn.jsdelivr.net/npm/wcex@1.9.77/index.js"></script>
  </head>
  <body>
    <!-- 挂载入口组件（与 app.html 同级） -->
    <app-></app->
  </body>
</html>
```
新建 `app.html`：
```html
<template>
  <meta name="scope" message="Hello WCEX" />
  <h1 :>欢迎使用：${message}</h1>
</template>
```
将 `index.html` 与 `app.html` 放在同一目录下，直接打开 `index.html` 即可看到渲染结果。`wcex` 会根据标签 `<app->` 自动拉取 `app.html` 并注册为自定义组件。

### 必备元信息
| 标签 / 属性                 | 作用                                                         |
| --------------------------- | ------------------------------------------------------------ |
| `<meta name="npm">`         | 指定默认 npm 静态资源 CDN 根路径。运行时在加载 `<meta name="module">` 声明的包时会使用该路径。 |
| `<meta name="colors">`      | 初始化配色方案，`mode` 为模式编号，其他属性（`pri` 等）可覆盖语义色初值。 |
| `<script src="...wcex...">` | 注入运行时。生产环境可固定版本（如 `@1.9.77`），开发阶段可指向本地构建产物。 |

#### 常用补充元标签
| 标签 / 属性                       | 说明                                                                                         |
| --------------------------------- | -------------------------------------------------------------------------------------------- |
| `<meta name="root" content="…">`  | 指定组件查找的根目录，未写 `http(s)` 时默认拼接在 `npmUrl` 后，可用于多仓合并或 VSCode 调试。 |
| `<meta name="npm" cors>`          | 为通过 CDN 拉取的脚本显式启用 CORS。                                                         |
| `<meta name="module" … url="…">`  | 直接指向模块根路径（可为 `http://localhost:8102/` 等本地地址），其余 `files`、`prefix` 相对该 URL 解析。 |
| `<meta name="module" deps="a;b">` | 声明依赖关系，运行时会先加载依赖模块。                                                       |
| `<meta name="module" export-name>`| 自定义模块默认导出的字段名称，适配部分库的命名导出。                                         |
| `<meta name="debug">`             | 开启调试输出（运行时根据值决定日志级别）。                                                   |
| `<meta name="lang" content="…">`  | 在运行时写入 `_htmlMeta.lang`，便于国际化逻辑读取。                                           |
| `<meta name="no-import-global-css">` | 阻止运行时注入全局样式表（默认会为 `@wcex/ui` 等库导入全局 shadow 样式）。               |

## 2.2 使用 @wcex/cli 构建工程
CLI 提供模板初始化、热更新、本地代理、TypeScript 编译、打包与自动化测试等能力。

### 安装与初始化
```bash
pnpm i -g @wcex/cli typescript   # 建议全局安装 TypeScript
mkdir my-app && cd my-app
wcex init                        # 在当前目录生成示例项目
```
初始化项目通常包含：
- `src/`：组件、静态资源与脚本（开发主目录）。
- `build/`：TypeScript 编译输出（开发时由 CLI 维护）。
- `dist/`：`wcex build` 生成的发布产物。
- `package.json`：记录依赖、版本与入口。

### 启动开发服务
```bash
wcex dev --dir src --port 8101 --host 127.0.0.1 --proxy /api=http://localhost:5000
```
主要特性：
- **热更新**：Watchpack 监听文件变动，通过 `/_hotws` WebSocket 通知浏览器，`HotLoader` 会按组件粒度替换模板并复用作用域。
- **TypeScript watch**：若项目存在 `tsconfig.json`，会自动运行 `tsc -w`。
- **依赖自动安装**：扫描 HTML 中的 `<meta name="module">` 声明，缺失时调用当前包管理器（优先 `pnpm`，其次 `yarn`、`npm`）安装依赖及对应 `@types/*`。
- **多目录挂载**：自动映射 `src/`、`build/src/`、`node_modules` 到静态服务根，可直接访问打包前/后的资源。
- **代理支持**：通过 `--proxy` 将特定路径转发至后端服务，便于联调。

浏览器访问 `http://127.0.0.1:8101/index.html` 即可实时预览。若使用 `meta name="module"` 引入 UI 包（如 `@wcex/ui`），CLI 会在启动时自动补齐依赖。

### 构建发布
```bash
wcex build --dir .
```
行为说明：
- 自动检测 `tsconfig.json`，若存在则运行单次 `tsc` 构建并把结果放入 `build/`。
- 遍历 `src/`，处理规则：HTML 使用 `html-minifier-terser` 压缩并保留头部注释；`.ts` 读取 `build/src` 对应产物再用 `terser` 压缩；其他文件直接复制。
- 构建完成后写入 `dist/`，同时将 `package.json` 复制入内并自动递增补丁号（第三位版本号）。
- 发布阶段会剔除 `<meta name="hot">`、`<meta name="debug">` 等仅供开发的标记。

### 模块化构建（可选）
若项目根目录包含 `module.json`，`wcex build` 会调用 `buildModule`：
- 支持同时打包 `html/` 与 `service/` 子项目（服务端部分需自行实现构建脚本）。
- 自动升级 `module.json` 中的版本号，汇总依赖并输出至 `dist/` 下，便于发布为“全栈组件模块”。

### UI 自动化测试
`wcex test` 通过 `puppeteer-core` 驱动浏览器执行用例：
```bash
wcex test --dir test --browser chrome --show
```
- `test` 目录下每个子目录若包含 `testEntry.html` 即视为一个用例。
- CLI 自动注入 `wcex` 与 `meta name="npm"`，加载完成后在页面 console 输出 `WCEX_TEST_END` 即表示用例结束。
- 支持并发执行（`--concurrent`）、自定义浏览器路径（使用 `locate-app` 自动查找常见浏览器）。

## 2.3 热更新与本地包联调
- 运行时会读取 `localStorage.__DEV` 中的 JSON（结构与 `IDev` 接口一致），从而将指定 npm 包映射到本地 `host:port`，并自动创建 `<meta name="module" url="...">` 用于联调。
- CLI 启动时同样会监听 `devConfig.pkgs`，并为开启的包建立 `ws://{hostport}/_hotws` 连接，将模板与脚本的改动推送给浏览器。
- 手动指定 `<meta name="module" url="http://127.0.0.1:8102/">` 也可以实现包级别的本地调试，`url` 与 `prefix`、`files` 组合后决定最终的加载地址。

## 2.4 运行时全局对象
加载 `wcex/index.js` 后会得到 `window.WCEX`，常用字段包括：
- `usePlugins(plugin)`：注册运行时插件（详见第 11 章）。
- `registerElement(elem, from?)`：显式注册自定义元素。
- `watch(obj)` / `noWatch(obj)`：获取代理对象或取消对对象的依赖追踪。
- `parseTag(tag)` / `buildTag(pkg, component)`：与运行时一致的标签解析和生成逻辑。
- `npmUrl`、`modules`、`amdloader`、`loadTime`：便于调试依赖解析和模块加载。

## 2.5 推荐开发工作流
1. 使用 `wcex init` 初始化项目，或手动创建 `index.html + app.html`。
2. 在入口 HTML 中设置 `meta name="npm"` 指向常用 CDN，必要时通过 `meta name="module"` 声明要预加载的 UI/工具包。
3. 启动 `wcex dev` 获取热更新体验；在组件中直接编写 `.ts` 文件，CLI 会同步编译。
4. 完成开发后执行 `wcex build` 产出压缩文件，或用 `wcex pack` 打包依赖。
5. 若涉及端到端 UI 校验，可编写测试入口并运行 `wcex test`。

凭借以上流程，可在无额外脚手架的情况下完成从开发到发布的全链路工作，适合自动化系统快速生成并验证 WCEX 代码。

## 智能体提示
- 在生成示例项目结构或引导脚本时，引用第 2.2 节的命令顺序，确保包含 `wcex init`、`wcex dev`、`wcex build`。
- 回答“如何联调本地包” 类问题时，明确提到 `localStorage.__DEV` 与 `<meta name="module" url="...">` 的双通道方案。
- 当提示用户调试 CDN/元信息配置时，可直接列出“必备元信息”表格中的标签，提醒 `meta name="npm"` 与 `meta name="colors"` 需同时设置。
- 解释热更新机制时，强调 CLI 的 `/_hotws` 与运行时 `HotLoader` 的配合，避免用户以为需要额外插件。
