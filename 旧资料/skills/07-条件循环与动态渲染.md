# 07｜条件循环与动态渲染

在 WCEX 中，条件判断、循环渲染和动态组件都通过指令式属性完成。本章整理 `$if`、`$show`、`$for` 等指令的完整写法，并介绍如何与插槽、动态组件协同。

## 7.1 条件渲染
### `$if`
```html
<div $if="user">欢迎 ${user.name}</div>
```
- 当表达式返回 `false`/`0`/`null`/`undefined`/空字符串时，元素会从 DOM 中移除。
- 条件变化时会重新创建或销毁节点，生命周期钩子会随之触发。
- 编译阶段会自动为带 `$if` 的元素生成一个 `<template>` 包裹节点，并通过 `if-eid` 与真实元素配对，因此可以安全地与 `$for`、`$as` 等指令组合使用。

### `$show`
```html
<wcex-ui.icon $show="count > 3" icon="star"></wcex-ui.icon>
```
- 仅控制显隐（通常通过切换 `hidden`、`display` 等方式实现），不会移除 DOM。
- 适用于频繁切换、需要保留内部状态的元素。
- `$show` 会缓存初始 `display`，切换为真时恢复；若仅希望隐藏可见性，可使用 `$vis` 将 `visibility` 置为 `hidden/visible`。

## 7.2 循环渲染 `$for`
### 基本写法
```html
<ul $items="[1,2,3]">
  <li $for="items">第 ${index} 项：${value}</li>
</ul>
```
- 省略参数时，循环变量默认为 `value`（当前项）与 `index`（索引）。
- 循环数据可以是数组、数字（表示重复次数）或对象（遍历键值对）。
- 运行时同样支持 `Set`、`Map` 甚至数字常量：数字会被视作执行次数，`Map`/对象的键作为 `index` 传入；对数组可搭配 `sort`/`$sort` 属性控制顺序（对象 `{ id: 1, 'meta.weight': 0 }` 表示多字段正反序，赋值 `false` 则倒序）。

### 解构参数
```html
<div $for(item,idx)="items">
  <span :>${idx + 1}. ${item.name}</span>
</div>

<div $for(type,key)="fonts" $if="fonts[type]">
  <h4 :>${type}</h4>
  <div $for="fonts[type]" :>${value.name}</div>
</div>
```
- `$for(item,idx)="array"`：分别指定当前项与索引名称。
- `$for(key,val)="object"`：遍历对象属性，`key` 为对象键、`val` 为值。

### 数字循环
```html
<div $for="5" :>${index + 1}</div>   <!-- 渲染 5 次 -->
```

### 排序与过滤
- 可以结合 `$if` 对循环项进行过滤。
- 在部分 UI 组件（如 `wcex-ui.list`）中，额外提供 `$sort` 属性用于排序：`$sort="{ id: 1 }"`。这是组件自定义的扩展，实际效果取决于目标组件实现。
- 模板上可设置 `sort` 属性（布尔/对象），框架会在克隆元素前对数组进行排序；`filter` 字段暂未内置实现，如需过滤请在表达式中处理，如 `$for="items.filter(v => v.active)"`。

## 7.3 动态组件 `$cmpt`
当需要根据数据渲染不同组件时，可使用 `$cmpt` 指定组件标签：
```html
<section $tabs="{'中文':'wcex-doc.com-cn_fonts','英文':'wcex-doc.com-en_fonts'}">
  <wcex-ui.tab $tabs="tabs" $$="curTab">
    <div slot="panel" $for="tabs" $cmpt="value">
      <div $as="cmpt"></div>
    </div>
  </wcex-ui.tab>
</section>
```
- `$cmpt="表达式"`：表达式返回的字符串将作为要渲染的标签名。可返回短名或全名。
- 渲染的组件会继承当前作用域，支持继续传递属性、插槽。
- 与 `$as` 搭配时会调用 `_replaceWithNewTag`，复制旧节点的属性、子节点及 `$scope`，因此适用于在运行时切换真实标签（需保证目标组件已经可用）。

## 7.4 作用域别名 `$as`
用于在局部范围内创建一个命名引用：
```html
<div $cmpt="$slot.value">
  <div $as="cmpt"></div>
</div>
```
- `$as="cmpt"` 会把当前元素的作用域暴露为 `cmpt`，便于脚本或子元素通过 `this.$scope.cmpt` 引用。
- 常与 `$cmpt`、`slot` 配合管理动态内容。

## 7.5 插槽与 `$slot`
WCEX 沿用了 Web Components 插槽语义：
```html
<template>
  <slot name="header"></slot>
  <main>
    <slot></slot>
  </main>
</template>
```
在使用者侧：
```html
<my-card>
  <h2 slot="header">标题</h2>
  <p>内容</p>
</my-card>
```
- 可通过 `$slot` 访问插槽信息（如 `this.$slot.value` 在动态选项中表示当前选项的值）。
- `@slotchange` 事件可以监听插槽内容变化。

## 7.6 组合场景示例
```html
<template>
  <meta name="scope" panels.array="[
    { name:'概览', component:'app-overview' },
    { name:'图表', component:'analytics-chart' },
    { name:'列表', component:'reports-table' }
  ]" active="0" />

  <nav>
    <button $for="panels" :class="active===index?'active':''" @click="active=index">
      ${value.name}
    </button>
  </nav>

  <section $if="panels[active]" $cmpt="panels[active].component">
    <div $as="panel"></div>
  </section>
</template>
```
- 通过 `$for` 渲染导航按钮；`$if` 确保仅在有数据时渲染内容。
- `$cmpt` 根据 `active` 动态加载不同的业务组件。
- `$as` 允许在脚本中通过 `this.panel` 访问子组件实例。

## 7.7 建议
- 条件与循环指令可以层层嵌套，但注意控制深度，必要时拆分子组件。
- 动态组件渲染时，请确保目标组件已存在（本地或通过 `meta module` 声明），否则会触发 `wc-error` 事件。
- 利用 `$for` 与 `$if` 组合可以快速创建筛选列表、树形结构等；保持数据结构清晰可提升自动化生成准确度。
- 当循环对象使用 `Map`/普通对象时，索引即为键。改变键含义会被视为移除旧节点并新增新节点，必要时可在模板中使用稳定的键值或提前复制数据。

掌握这些指令，可在纯 HTML 中完成复杂的流控制与动态内容组织，而无需额外模板编译步骤。

## 智能体提示
- 对条件场景优先建议 `$if`（真正销毁）或 `$show`（仅隐藏），并解释二者对生命周期及状态保留的区别。
- 循环语法中请说明默认变量 `value/index`，必要时借助 `$for(item,idx)` 显式命名，避免与父作用域冲突。
- 生成动态组件时，提示 `$cmpt` 依赖目标标签已经注册，若跨包引用需结合 `<meta module>`。
- 当问题涉及插槽或作用域引用，提及 `$slot` 与 `$as` 的配合方式，帮助用户在脚本中定位子组件。
