# 17｜开发调试

WCEX 提供本地持久化的调试配置、热更新通道以及可视化 Dev Panel，便于快速排障。本章以智能体视角总结实操步骤，帮助自动化脚本在开发环境中完成诊断。

## 17.1 启用调试模式
- 框架在启动时会读取 `localStorage.__DEV`，恢复 `debugOutput`（日志级别开关）与 `pkgs`（包级热更新地址等配置）。若不存在则使用默认空对象。
- 通过 `<meta name="debug">` 也可强制开启调试输出。Logger 会根据 `debugOutput` 或此 meta 决定是否打印 `debug/log` 级别，并在日志前附带耗时统计。
- 当检测到 `__DEV` 存在时，`wcex-ui.dev` 组件会自动挂载 Dev Panel 并监听快捷键，无需额外引导。

## 17.2 Dev Panel 快捷键
- `Ctrl/Alt + \``：打开或聚焦 Dev Panel，面板固定在视口上方，可直接输入或修改配置。
- `Ctrl + Shift + 鼠标移动`：实时高亮当前命中的 Web Component，显示标签名和边界，便于定位 Shadow DOM。
- `Ctrl + Shift + 右键`：在当前元素展开帮助面板，同时收集父、子以及 Shadow DOM 内的相关自定义元素，方便逐一查看文档。
- 面板依赖焦点，失焦会自动收起并移除辅助高亮。

## 17.3 配置面板（`<dev-config>`）
核心能力：
1. **日志开关**：绑定 `dev.debugOutput`，变化后立即写入 `localStorage.__DEV`，与 Logger 行为联动。
2. **包级热更新**：列出 `WCEX.modules` 中的所有包，可逐项配置 `host:port` 与 `enable`。当启用但缺少地址时会自动回填 `localhost:8101`。
3. **组件树浏览**：递归扫描 `document.body` 与 Shadow DOM，生成可折叠的 Web Component 列表。适合排查嵌套结构或快速跳转。

Scope 内使用 `$watch(() => this.$json(this.dev))` 同步本地存储，保证刷新后仍保留最新设置。

## 17.4 帮助面板（`<dev-help>`）
- 右键触发后，帮助面板会解析选中组件及其关联标签的模板注释。若注释以 `!!` 开头，则第一段作为摘要，其余行可通过 `@prop foo 文本`、`@event submit ...` 等形式描述属性、事件或插槽。
- 面板顶部展示标签列表，可在同级、父级与子级组件之间切换。正文采用 Markdown 渲染，便于嵌入代码片段或表格。
- 推荐在新增组件时同步维护 `!!` 注释，以确保帮助面板呈现的内容始终准确。

## 17.5 热更新与包联调
- `devConfig.pkgs` 记录每个包的热更新开关与服务地址。启用后，框架会向 `http://{host}/package.json` 探测包名，再与 `ws://{host}/_hotws` 建立通信。
- Dev Server 通过 WebSocket 推送 `{ project, path }` 消息时，会触发 `_replaceWithNewTag`：重新加载模板、刷新所有实例，而无需整页重载。
- 推荐流程：
  1. 在 Dev Panel 勾选目标包并填写地址。
  2. 启动对应包的开发服务器，确保暴露 `_hotws`。
  3. 观察控制台 `hot tag:` 日志确认热更成功；若提示 `no match`，请检查路径或包名是否一致。

## 17.6 辅助工具
- **元素选择器**：Dev Panel 自带固定定位的高亮框，用于展示当前命中的组件区域。
- **尺寸监听**：结合 `$monitSize` 插件，可在调试脚本中观察容器尺寸波动，并根据 `ResizeObserverEntry` 结果刷新布局。
- **全局日志**：`window.Log` 默认可用，配合 Dev Panel 的 “Enable Debug Output” 以及 `<meta name="debug">` 一起控制噪声级别。
- **性能观察**：`WCEX.loadTime` 会在主文档解析完成后更新，可用于度量页面初始化时长。必要时可在 Dev Panel 中增加自定义显示。

> 将 Dev Panel、模板注释规范与热更新配置纳入日常流程：创建组件时写好 `!!` 注释，联调前确认包名与端口，必要时脚本可直接读写 `localStorage.__DEV` 来模拟人工操作。
