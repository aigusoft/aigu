# 11｜路由系统

WCEX 内置基于 URL Hash 的分区路由。它以 `/path/#areaTag?query;other:tag?query` 的格式描述多区域同时展示的页面结构。理解 `$router` API、`route` 容器组件以及导航组件的协作，有助于构建单页应用。

## 11.1 路由格式
- **基本格式**：`/#tag?key=value&...`
- **多分区**：`/#main:dashboard?tab=stats;sidebar:menu?item=overview`
  - `main`、`sidebar` 为路由区域（area），默认区域名为 `default`。
  - `tag` 对应要渲染的组件标签（遵循第 3 章的命名规则）。
  - `attrs` 为传递给组件的属性，会自动同步到 `Scope` 与 DOM 属性中。

当 URL Hash 变化时，框架会解析成结构化对象注入到 `$router.route`：
```ts
{
  default: { tag: 'com-main', attrs: { a: '1', b: '2' } },
  menu:    { tag: 'com-menu', attrs: { c: '3', d: '4' } }
}
```

## 11.2 `$router` API
`Scope` 内置 `$router` 对象及快捷方法 `$go`：
- `this.$router.route`：当前解析结果（按区域划分）。
- `this.$router.go(areaOrHref, tag?, attrs?)`：更新当前路由。
  - 写法 1：`this.$router.go('wcex-doc.doc', { url, lang })` → 作用于默认区域。
  - 写法 2：`this.$router.go('menu', 'app-menus', { code: 'main' })` → 指定区域。
  - 写法 3：`this.$router.go('#app-home?step=1')` / 直接传入完整 hash 字符串。
- 写法 4：传入路由对象：`this.$router.go({ sidebar: { tag: 'app-menu', attrs: { tab: 'config' }}})`，系统会与现有 `route` 合并。
- `this.$router.back()`：回退到上一个路由（依据历史栈）。
- `this.$router.parse(href)`：解析任意符合格式的字符串，返回结构化对象。

快捷方法 `$go` 与 `$router.go` 行为相同，可根据习惯选择。

`$router.route` 是通过 `Observer.watch` 代理的响应式对象，直接在组件中访问或 `watch` 它的属性即可在路由变更时收到通知；同时 `WCEX.buildTag/parseTag` 可帮助生成符合规范的标签名称。

## 11.3 `route` 容器组件
`@wcex/ui` 提供了通用路由容器 `<wcex-ui.route>`，负责根据 `$router.route` 信息加载自定义元素。
```html
<wcex-ui.route name="default" home="app-home" match="^app-" @error="handle404()"></wcex-ui.route>
```
属性说明：
- `name`：路由区域名，默认 `default`。
- `home`：当区域没有匹配项或 `tag` 为空时跳转到的默认组件。
- `match`：正则表达式，匹配失败时触发 `error` 事件。
- `overflow`：设置容器滚动行为（如 `auto`）。
- `check-route-fn`：可传入函数，对路由进行自定义校验（返回 `false` 则阻止跳转）。

工作流程：
1. 监听 `route-change` 事件或初始化时读取 `$router.route[name]`。
2. 将参数写入 `#route` 容器元素，并设置 `component` 属性为对应标签。
3. 若 `tag` 不含 `-` 或不符合规则则触发 `error` 事件。
4. 路由组件内部会执行 `this.changeRouter()`，呼应 `$router.go()` 的调用。

## 11.4 导航组件与路由联动
`@wcex/ui.nav` 演示了如何与 `$router` 协同：
```html
<wcex-ui.nav route-name="default" @click.stop="onClick($ev)">
  <a href="#default:app-dashboard?section=overview">概览</a>
  <a href="#default:app-dashboard?section=detail">详情</a>
</wcex-ui.nav>
```
- 组件内部通过 `this.$router.parse(href)` 分析链接，匹配当前路由时为元素设置 `checked` 状态。
- 点击时读取 `href` 属性并调用 `this.$router.go(href)`。

在常见的导航菜单中，可以直接在事件中调用 `$router.go('区域名', '组件名', attrs)`，例如：
```html
@click.1="$router.go('docs.doc',{url:value.path,lang:$root.lang})"
```
通过 `$router.route.default.attrs` 获取当前参数，配合 `$router.go` 实现左侧导航的激活与跳转。

## 11.5 监听路由变化
- DOM 事件：`window.addEventListener('route-change', handler)`。`route-change` 在 Hash 解析后触发，可用于全局响应。
- 组件事件：`@router-change="onRouteChanged()"` 可直接写在 `<template>` 上。
- Scope 方法：实现 `onRouterChange()`（或自定义方法）即可在脚本中响应。

示例：
```html
<template @router-change="$log('route update')" @timer.500="url=frameUrl()">
  ...
  frameUrl() {
    return decodeURI(this.$router.route.default.attrs.url || '');
  }
</template>
```

## 11.6 错误处理与回退
- `wcex-ui.route` 在解析失败或加载组件出现问题时，会触发 `error` 事件并尝试跳转 `home`。
- 全局还会触发 `wc-error` 事件，可在根组件监听并执行容错逻辑：
  ```js
  window.addEventListener("wc-error", () => {
    this.$log.error("component load failed");
    this.$router.go('app-home');
  });
  ```
- CLI 与运行时在加载失败时输出错误信息，便于调试包名或路径。

## 11.7 常见模式
1. **多区域布局**：使用多个 `<wcex-ui.route>` 分别渲染主内容与侧边栏，每个区域对应不同的标签。
2. **嵌套路由**：子组件内继续调用 `$router.go` 更新自身区域，实现局部刷新。
3. **带参数的导航**：菜单项通过 `href` 或脚本调用 `go`，属性自动同步到组件 `this.$id.route` 及其 `Scope`。
4. **返回上一级**：在组件内调用 `this.$router.back()`，结合 `history.length` 判断是否可回退。

## 11.8 建议
- 使用正则 `match` 或 `check-route-fn` 确保只加载预期组件，避免恶意路由导致异常请求。
- 管理好默认 `home` 路由，确保首次进入或非法路由时能够回退到有效页面。
- 导航组件中建议显式设置 `href`，方便右键打开、复制链接，同时保持 `@click` 调用 `$router.go` 提供 SPA 体验。

熟练掌握这些路由 API，可搭建多视图页面、保持状态同步，并为自动化智能体提供明确的跳转语义。

## 智能体提示
- 当解释 Hash 结构时，说明“区域:组件?属性” 的格式，并展示多区域示例，避免误将 `;` 当作查询分隔符。
- 导航逻辑尽量使用 `$router.go` 而非手写 `location.hash`，同时保留 `href` 以满足可访问性。
- 推荐在回答中搭配 `<wcex-ui.route>` 的 `home`、`match` 属性，提醒用户配置默认页和白名单。
- 若涉及监听，指出三种方式：`window` 事件、`@router-change`、`onRouterChange()`，帮助用户根据场景选择。
